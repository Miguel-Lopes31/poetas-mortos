{% extends "base.html" %}

{% block title %}{% if book_id %}Editar Livro{% else %}Novo Livro{% endif %} - Biblioteca Pessoal{% endblock %}

{% block content %}
<div x-data="bookFormApp({{ book_id or 'null' }})" x-init="init()">
    <!-- Page Header -->
    <header class="page-header">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="page-title" x-text="isEditing ? 'Editar Livro' : 'Novo Livro'"></h1>
                <p class="page-subtitle"
                    x-text="isEditing ? 'Atualize as informa√ß√µes do livro' : 'Adicione um novo livro √† sua biblioteca'">
                </p>
            </div>
            <template x-if="isEditing">
                <button class="btn btn-danger" @click="deleteBook()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Excluir
                </button>
            </template>
        </div>
    </header>

    <!-- Loading -->
    <template x-if="loading">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </template>

    <!-- Form -->
    <template x-if="!loading">
        <form @submit.prevent="saveBook()" class="card" data-aos="fade-up">
            <!-- Basic Info -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Informa√ß√µes B√°sicas
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="title">T√≠tulo *</label>
                        <input type="text" id="title" class="form-input" x-model="book.title" required
                            placeholder="Ex: Dom Casmurro">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="author">Autor</label>
                        <input type="text" id="author" class="form-input" x-model="book.author"
                            placeholder="Ex: Machado de Assis">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="publisher">Editora</label>
                        <input type="text" id="publisher" class="form-input" x-model="book.publisher"
                            placeholder="Ex: Companhia das Letras">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="genre">G√™nero</label>
                        <input type="text" id="genre" class="form-input" x-model="book.genre"
                            placeholder="Ex: Romance, Fic√ß√£o, etc.">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="pages">N√∫mero de P√°ginas</label>
                        <input type="number" id="pages" class="form-input" x-model.number="book.pages" min="1"
                            placeholder="Ex: 256">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="current_page">P√°ginas J√° Lidas</label>
                        <input type="number" id="current_page" class="form-input" x-model.number="book.current_page"
                            min="0" :max="book.pages || 99999" placeholder="Ex: 50">
                        <small class="form-hint" x-show="book.pages && book.current_page">
                            <span x-text="Math.round((book.current_page / book.pages) * 100)"></span>% lido
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="cover_url">URL da Capa</label>
                        <input type="url" id="cover_url" class="form-input" x-model="book.cover_url"
                            placeholder="https://...">
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Status
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="status">Status de Leitura</label>
                        <select id="status" class="form-select" x-model="book.status">
                            <option value="want_to_read">‚≠ê Quero Ler</option>
                            <option value="reading">üìñ Lendo</option>
                            <option value="read">‚úÖ Lido</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="priority">Prioridade</label>
                        <select id="priority" class="form-select" x-model="book.priority">
                            <option value="high">üî• Quero Muito</option>
                            <option value="normal">üôÇ Normal</option>
                            <option value="low">üí§ Sem Pressa</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Purchase Info -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Informa√ß√µes de Compra
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="purchase_place">Onde Comprou</label>
                        <input type="text" id="purchase_place" class="form-input" x-model="book.purchase_place"
                            placeholder="Ex: Amazon, Livraria Cultura">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="purchase_price">Pre√ßo Pago (R$)</label>
                        <input type="number" id="purchase_price" class="form-input" x-model.number="book.purchase_price"
                            min="0" step="0.01" placeholder="Ex: 39.90">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="purchase_date">Data da Compra</label>
                        <input type="date" id="purchase_date" class="form-input" x-model="book.purchase_date">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="delivery_days">Dias para Chegar</label>
                        <input type="number" id="delivery_days" class="form-input" x-model.number="book.delivery_days"
                            min="0" placeholder="Ex: 5">
                    </div>
                </div>
            </div>

            <!-- Reading Info -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Informa√ß√µes de Leitura
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="start_date">Data de In√≠cio</label>
                        <input type="date" id="start_date" class="form-input" x-model="book.start_date">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="end_date">Data de T√©rmino</label>
                        <input type="date" id="end_date" class="form-input" x-model="book.end_date">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Avalia√ß√£o</label>
                    <div class="book-rating" style="font-size: var(--text-2xl); cursor: pointer;">
                        <template x-for="i in 5" :key="i">
                            <span class="star" :class="{ 'filled': i <= book.rating }" @click="book.rating = i"
                                @mouseenter="hoverRating = i" @mouseleave="hoverRating = 0"
                                :style="{ opacity: hoverRating >= i ? 1 : (book.rating >= i ? 1 : 0.3) }">‚òÖ</span>
                        </template>
                        <button type="button" class="btn btn-secondary" style="margin-left: var(--space-md);"
                            @click="book.rating = null" x-show="book.rating">
                            Limpar
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="observations">Observa√ß√µes</label>
                    <textarea id="observations" class="form-textarea" x-model="book.observations" rows="4"
                        placeholder="Ex: Edi√ß√£o linda, papel de qualidade..."></textarea>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-md justify-between">
                <a href="/biblioteca" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-lg" :disabled="saving">
                    <template x-if="!saving">
                        <span x-text="isEditing ? 'Salvar Altera√ß√µes' : 'Adicionar Livro'"></span>
                    </template>
                    <template x-if="saving">
                        <span>Salvando...</span>
                    </template>
                </button>
            </div>
        </form>
    </template>
</div>
{% endblock %}

{% block scripts %}
<script>
    function bookFormApp(bookId) {
        return {
            loading: false,
            saving: false,
            isEditing: bookId !== null,
            bookId: bookId,
            hoverRating: 0,
            book: {
                title: '',
                author: '',
                publisher: '',
                genre: '',
                pages: null,
                current_page: 0,
                cover_url: '',
                status: 'want_to_read',
                priority: 'normal',
                purchase_place: '',
                purchase_price: null,
                purchase_date: '',
                delivery_days: null,
                start_date: '',
                end_date: '',
                rating: null,
                observations: ''
            },

            async init() {
                if (this.isEditing) {
                    this.loading = true;
                    await this.loadBook();
                    this.loading = false;
                }
            },

            async loadBook() {
                try {
                    const response = await fetch(`/api/books/${this.bookId}`);
                    if (!response.ok) throw new Error('Livro n√£o encontrado');

                    const data = await response.json();
                    this.book = {
                        ...data,
                        purchase_date: data.purchase_date || '',
                        start_date: data.start_date || '',
                        end_date: data.end_date || ''
                    };
                } catch (error) {
                    console.error('Erro ao carregar livro:', error);
                    showToast('Erro ao carregar livro', 'error');
                    window.location.href = '/biblioteca';
                }
            },

            async saveBook() {
                if (!this.book.title) {
                    showToast('O t√≠tulo √© obrigat√≥rio', 'error');
                    return;
                }

                this.saving = true;

                try {
                    const url = this.isEditing ? `/api/books/${this.bookId}` : '/api/books';
                    const method = this.isEditing ? 'PUT' : 'POST';

                    // Clean up empty values
                    const bookData = { ...this.book };
                    Object.keys(bookData).forEach(key => {
                        if (bookData[key] === '' || bookData[key] === null) {
                            bookData[key] = null;
                        }
                    });

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookData)
                    });

                    if (!response.ok) throw new Error('Erro ao salvar');

                    showToast(this.isEditing ? 'Livro atualizado!' : 'Livro adicionado!', 'success');
                    window.location.href = '/biblioteca';
                } catch (error) {
                    console.error('Erro ao salvar livro:', error);
                    showToast('Erro ao salvar livro', 'error');
                } finally {
                    this.saving = false;
                }
            },

            async deleteBook() {
                if (!confirm('Tem certeza que deseja excluir este livro? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/books/${this.bookId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('Erro ao excluir');

                    showToast('Livro exclu√≠do!', 'success');
                    window.location.href = '/biblioteca';
                } catch (error) {
                    console.error('Erro ao excluir livro:', error);
                    showToast('Erro ao excluir livro', 'error');
                }
            }
        };
    }
</script>
{% endblock %}